package base;

import java.io.IOException;
import database.GroupServer;
import database.MessageServer;
import net.jxta.discovery.DiscoveryService;
import net.jxta.peergroup.PeerGroup;
import net.jxta.pipe.InputPipe;
import net.jxta.pipe.OutputPipe;
import net.jxta.pipe.PipeService;
import net.jxta.platform.NetworkConfigurator;
import net.jxta.platform.NetworkManager;
import net.jxta.protocol.PipeAdvertisement;

/**
 * Stores the the configuration, and all needed variables
 *   
 * @author Torsten Burschka
 */

public class Configuration {

	/**
	 * Project name
	 */
	public static String project = "MarsMissionII";
	
	/**
	 * Profile 
	 */
	public static String profileName = "Node";
	
	/**
	 * Node principal
	 */
	public static String principal = profileName;
	
	/**
	 * Node password
	 */
	public static String password = "mars2007";
	
	/**
	 * Name of the rendezvous file
	 */
	public static String rendezvousFile = "rdv.lst";
	
	/**
	 * Name of the relay File
	 */
	public static String relayFile = "rly.lst";
	
	/**
	 * The global path
	 */
	private static String globalPath = "";
	
	/**
	 * The profile path
	 */
	private static String profilePath = "";
	
	/**
	 * PeerGroup
	 */
	public static PeerGroup netPeerGroup = null;
	
	/**
	 * Max of subPeerGroups
	 */
	private static int maxSubPeerGroups = 5;
	
	/**
	 * Array of subPeerGroups - maxSubPeergroups are supported
	 */
	public static PeerGroup subPeerGroups[] = new PeerGroup[maxSubPeerGroups];

	/**
	 * Number of subPeerGroups, which acutally used
	 */
	public static int subPeerGroupsUsed = 0;
	
	/**
	 * Stores the configuration
	 */
	public static NetworkConfigurator configuration = null;

	/**
	 * Pipe Advertisement
	 */
	public static PipeAdvertisement pipeAdv = null;
	
	/**
	 * Pipe Service
	 */
	public static PipeService pipeServ = null;
	
	/**
	 * Discovery Service
	 */
	public static DiscoveryService discServ = null;
	
	/**
	 * NetworkManager
	 */
	public static NetworkManager manager; 
	
	/**
	 * Input pipe
	 */
	public static InputPipe inputPipe = null;
	
	/**
	 * Output pipe
	 */
	public static OutputPipe outputPipe = null;

	/**
	 * Message container for outgoing messages
	 */
	public static net.jxta.endpoint.Message message_out = null;

	/**
	 * Time to wait for a rendezvous connection in msec
	 */
	public static long waitTime = 10000;	
	
	/**
	 * Initiate the Configuration with values
	 * @param profile
	 *        the profile you want to use
	 */
	public static void init (String profile) {
		profileName = profile;
		System.setProperty("JXTA_HOME","."+project+"_"+profileName);
		configuration = new NetworkConfigurator();
		profilePath = System.getProperty("JXTA_HOME") + "\\";
		globalPath = System.getProperty("JXTA_HOME").replaceAll("\\"+"."+project+"_"+profileName,"");
		if (!configuration.exists()) {
			createConfig();
		} else {
			System.out.println(profileName+": Configuration found.");
			RendezvousList.addHostAdresses();
		}
		System.out.println("create connection to message database.");
		GroupServer.createGroupDatabase();
		MessageServer.createMessageDatabase();
	}
	
	/**
	 * Creates the default Node Configuration
	 */
	private static void createConfig() {
		// Create a new configuration with a new name, principal, and pass
		System.out.println("\n"+profileName+": No configuration found. Autogenerate a new configuration.");
		configuration.setName(profileName);
		configuration.setPrincipal(profileName);
		configuration.setPassword(password);
		configuration.setDescription("Autogenerated Platform Config Advertisement.");
		configuration.setTcpEnabled(true);
		configuration.setTcpIncoming(true);
		configuration.setTcpOutgoing(true);
		configuration.setHttpEnabled(false);
		configuration.setHttpIncoming(false);
		configuration.setHttpOutgoing(false);
		configuration.setUseMulticast(false);
		configuration.setUseOnlyRendezvousSeeds(true);
		configuration.addRdvSeedingURI(Utilities.toURI(Configuration.getProfilePath()+rendezvousFile));
		configuration.setTcpPort(9702);
		configuration.setTcpEndPort(9702);
		configuration.setTcpStartPort(9702);
		configuration.setUseOnlyRelaySeeds(false);
		configuration.setMode(NetworkConfigurator.TCP_CLIENT
				+ NetworkConfigurator.TCP_SERVER);
		try {
			// persist it
			configuration.save();

		} catch (IOException ioe) {
			System.err.println("\n"+profileName+": Could not save the configuration!");
			System.err.println("\n"+profileName+": Error Message:");
			ioe.printStackTrace();
			System.err.println();
		}
		RendezvousList.addHostAdresses();
	}
	
	/**
	 * Change the configuration to act as a rendezvous
	 */
	public static void setAsRendezvous() {
		System.out.println("\n"+profileName+":Set configuration to rendezvous server.");
		configuration.setHttpEnabled(true);
	    configuration.setHttpIncoming(true);
	    configuration.setHttpOutgoing(true);
	    configuration.setHttpPort(9700);
	    configuration.setTcpEnabled(true);
	    configuration.setTcpIncoming(true);
	    configuration.setTcpOutgoing(true);
	    configuration.setUseMulticast(false);
	    configuration.setTcpPort(9701);
	    configuration.setUseOnlyRendezvousSeeds(false);
	    configuration.setUseOnlyRelaySeeds(false);
	    configuration.setTcpEndPort(9701);
	    configuration.setTcpStartPort(9701);
	    configuration.addRdvSeedingURI(Utilities.toURI(Configuration.getProfilePath()+rendezvousFile));
	    configuration.addRelaySeedingURI(Utilities.toURI(Configuration.getProfilePath()+rendezvousFile));
	    configuration.setMode(NetworkConfigurator.RDV_SERVER
	        +NetworkConfigurator.TCP_SERVER+NetworkConfigurator.TCP_CLIENT
	        +NetworkConfigurator.RELAY_SERVER+NetworkConfigurator.HTTP_SERVER
	        +NetworkConfigurator.HTTP_CLIENT);
		try {
			// persist it
			configuration.save();

		} catch (IOException ioe) {
			System.err.println("\n"+profileName+": Could not save the configuration!");
			System.err.println("\n"+profileName+": Error Message:");
			ioe.printStackTrace();
			System.err.println();
		}
	}

	/**
	 * Returns the global path
	 * @return the global path
	 */
	public static String getGlobalPath() {
		return globalPath;
	}

	/**
	 * Returns the profile path
	 * @return the profile path
	 */
	public static String getProfilePath() {
		return profilePath;
	}
	
	/**
	 * Returns the max number of subPeerGroups
	 * @return the max number of subPeerGroups
	 */
	public static int getMaxSubPeerGroups() {
		return maxSubPeerGroups;
	}
}